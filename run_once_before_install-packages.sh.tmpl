#!/bin/bash
# run_once_before_install-packages.sh
# This script runs once during chezmoi apply (before other files)
# The 'before' prefix ensures it runs before dotfiles are applied

set -e

echo "=== Setting up dotfiles ==="

# Ensure Homebrew is in PATH based on platform and architecture
if [[ "$(uname)" == "Darwin" ]]; then
    # macOS: Check for ARM64 (Apple Silicon) or x86_64 (Intel)
    if [[ -d /opt/homebrew ]]; then
        # Apple Silicon Homebrew
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -d /usr/local/Homebrew ]]; then
        # Intel Homebrew
        eval "$(/usr/local/bin/brew shellenv)"
    fi
elif [[ -d /home/linuxbrew/.linuxbrew ]]; then
    # Linux Homebrew
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# Install Homebrew packages
if command -v brew &> /dev/null; then
    echo "Installing Homebrew packages..."
    # Continue even if some packages fail (e.g., Docker Desktop on macOS)
    brew bundle --file="{{ .chezmoi.sourceDir }}/Brewfile" || echo "Some packages failed to install (this may be expected)"
else
    echo "WARNING: Homebrew not found. Please install it first:"
    echo '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
    exit 1
fi

# Ensure zsh history directory exists
mkdir -p "${XDG_STATE_HOME:-$HOME/.local/state}/zsh"

echo "=== Package installation complete ==="
