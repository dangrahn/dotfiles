# ~/.config/zsh/.zshrc - Interactive shell configuration
# Only loaded for interactive shells

# ===== Early Setup =====

# Create required directories
[[ -d "${XDG_STATE_HOME}/zsh" ]] || mkdir -p "${XDG_STATE_HOME}/zsh"

# ===== Completions (must be before plugins) =====

autoload -Uz compinit
# Only regenerate completion dump once per day
if [[ -n ${ZDOTDIR}/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C
fi

# Completion styling
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'  # Case-insensitive

# ===== Antidote Plugin Manager =====

# Source antidote
source "${XDG_DATA_HOME:-$HOME/.local/share}/antidote/antidote.zsh"

# Generate and source plugins from plugins.txt
antidote load "${ZDOTDIR}/plugins.txt"

# ===== Shell Options =====

setopt AUTO_CD              # cd by typing directory name
setopt AUTO_PUSHD           # Push directories to stack
setopt PUSHD_IGNORE_DUPS    # No duplicates in dir stack
setopt PUSHD_SILENT         # Don't print stack after pushd/popd

setopt EXTENDED_HISTORY     # Add timestamps to history
setopt HIST_IGNORE_ALL_DUPS # Remove older duplicates
setopt HIST_REDUCE_BLANKS   # Remove superfluous blanks
setopt HIST_VERIFY          # Show command before executing from history
setopt INC_APPEND_HISTORY   # Add immediately to history
setopt SHARE_HISTORY        # Share history between sessions

setopt COMPLETE_IN_WORD     # Complete from cursor position
setopt ALWAYS_TO_END        # Move cursor to end after completion
setopt NO_BEEP              # No beeping
setopt NO_LIST_BEEP         # No beeping on ambiguous completion

# ===== Key Bindings =====

# Better history search with arrow keys
autoload -U up-line-or-beginning-search down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search
bindkey "^[[A" up-line-or-beginning-search    # Up arrow
bindkey "^[[B" down-line-or-beginning-search  # Down arrow

# Word navigation
bindkey '^[[1;5C' forward-word   # Ctrl+Right
bindkey '^[[1;5D' backward-word  # Ctrl+Left

# ===== Tool Integrations =====

# fnm (Fast Node Manager)
if command -v fnm &> /dev/null; then
    eval "$(fnm env --use-on-cd --shell zsh)"
fi

# direnv
if command -v direnv &> /dev/null; then
    eval "$(direnv hook zsh)"
fi

# GRC colorization
if command -v grc &> /dev/null; then
    [[ -f /opt/homebrew/etc/grc.zsh ]] && source /opt/homebrew/etc/grc.zsh
    [[ -f /home/linuxbrew/.linuxbrew/etc/grc.zsh ]] && source /home/linuxbrew/.linuxbrew/etc/grc.zsh
fi

# Starship prompt (must be last prompt-related)
if command -v starship &> /dev/null; then
    eval "$(starship init zsh)"
fi

# ===== Source Modular Configs =====

[[ -f "${ZDOTDIR}/aliases.zsh" ]] && source "${ZDOTDIR}/aliases.zsh"
[[ -f "${ZDOTDIR}/functions.zsh" ]] && source "${ZDOTDIR}/functions.zsh"

# Local overrides (not in git)
[[ -f "${ZDOTDIR}/.zshrc.local" ]] && source "${ZDOTDIR}/.zshrc.local"
